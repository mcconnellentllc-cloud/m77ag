<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunting System Diagnostic - M77 AG</title>
    <style>
        body {
            font-family: monospace;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c5530;
        }
        .test {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ccc;
            border-radius: 4px;
        }
        .test.running {
            border-left-color: #ffc107;
        }
        .test.success {
            border-left-color: #4caf50;
        }
        .test.error {
            border-left-color: #f44336;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            font-size: 12px;
        }
        button {
            background: #2c5530;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px 0;
        }
        button:hover {
            background: #1f3d22;
        }
        .summary {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 18px;
        }
        .summary.all-good {
            border: 3px solid #4caf50;
            color: #2e7d32;
        }
        .summary.has-errors {
            border: 3px solid #f44336;
            color: #c62828;
        }
    </style>
</head>
<body>
    <h1>üîç Hunting System Diagnostic Test</h1>
    <p>This page tests all hunting booking endpoints to verify everything is working correctly.</p>

    <button onclick="runAllTests()">Run All Tests</button>

    <div id="tests"></div>

    <div id="summary"></div>

    <script>
        const tests = [
            {
                name: 'Server Health Check',
                endpoint: '/api/test',
                method: 'GET'
            },
            {
                name: 'Load Booked Dates',
                endpoint: '/api/hunting/booked-dates',
                method: 'GET',
                expectedKeys: ['success', 'bookings']
            },
            {
                name: 'Load Game Rest Dates',
                endpoint: '/api/hunting/game-rest-dates',
                method: 'GET',
                expectedKeys: ['success', 'gameRestDates']
            },
            {
                name: 'Database Connection',
                endpoint: '/api/test',
                method: 'GET',
                check: (data) => data.mongodb === 'connected'
            }
        ];

        async function runTest(test) {
            const testDiv = document.getElementById(`test-${test.name.replace(/\s+/g, '-')}`);
            testDiv.className = 'test running';

            try {
                const response = await fetch(test.endpoint, {
                    method: test.method
                });

                const data = await response.json();

                let success = response.ok;

                // Check for expected keys
                if (test.expectedKeys) {
                    success = success && test.expectedKeys.every(key => key in data);
                }

                // Custom check
                if (test.check) {
                    success = success && test.check(data);
                }

                testDiv.className = success ? 'test success' : 'test error';

                const resultDiv = testDiv.querySelector('.result');
                resultDiv.innerHTML = `
                    <strong>Status:</strong> ${response.status} ${response.statusText}<br>
                    <strong>Success:</strong> ${success ? '‚úÖ PASS' : '‚ùå FAIL'}<br>
                    <strong>Response:</strong><br>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

                return { success, test: test.name };

            } catch (error) {
                testDiv.className = 'test error';
                const resultDiv = testDiv.querySelector('.result');
                resultDiv.innerHTML = `
                    <strong>‚ùå ERROR:</strong> ${error.message}
                `;
                return { success: false, test: test.name, error: error.message };
            }
        }

        async function runAllTests() {
            // Clear previous results
            document.getElementById('tests').innerHTML = '';
            document.getElementById('summary').innerHTML = '';

            // Create test divs
            tests.forEach(test => {
                const testDiv = document.createElement('div');
                testDiv.className = 'test';
                testDiv.id = `test-${test.name.replace(/\s+/g, '-')}`;
                testDiv.innerHTML = `
                    <h3>${test.name}</h3>
                    <div><strong>Endpoint:</strong> ${test.method} ${test.endpoint}</div>
                    <div class="result">Running...</div>
                `;
                document.getElementById('tests').appendChild(testDiv);
            });

            // Run tests sequentially
            const results = [];
            for (const test of tests) {
                const result = await runTest(test);
                results.push(result);
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            // Show summary
            const passedTests = results.filter(r => r.success).length;
            const totalTests = results.length;
            const allPassed = passedTests === totalTests;

            const summaryDiv = document.getElementById('summary');
            summaryDiv.className = allPassed ? 'summary all-good' : 'summary has-errors';
            summaryDiv.innerHTML = `
                <h2>${allPassed ? '‚úÖ All Tests Passed!' : '‚ö†Ô∏è Some Tests Failed'}</h2>
                <p><strong>${passedTests} / ${totalTests}</strong> tests passed</p>
                ${allPassed ?
                    '<p>‚úÖ The hunting booking backend is working correctly!</p><p>If you\'re still having issues with the booking form, it\'s likely a browser cache or JavaScript error. Try hard-refreshing the hunting page (Ctrl+Shift+R).</p>' :
                    '<p>‚ùå There are backend issues that need to be fixed. See the failed tests above for details.</p>'
                }
            `;
        }
    </script>
</body>
</html>
