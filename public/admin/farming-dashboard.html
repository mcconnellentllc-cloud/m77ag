<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farming Admin Dashboard - M77 AG</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f3f0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
            color: white;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #d4af37;
        }

        .breadcrumb {
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        .breadcrumb a {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: #d4af37;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .role-badge {
            background: linear-gradient(135deg, #d4af37 0%, #c4a030 100%);
            color: #1a1a1a;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .btn-logout {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.2);
            border-color: #d4af37;
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        .page-header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-header h1 {
            color: #2d5016;
            font-size: 28px;
        }

        .page-header p {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d4af37 0%, #c4a030 100%);
            color: #1a1a1a;
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212,175,55,0.4);
        }

        .btn-secondary {
            background: white;
            color: #2d5016;
            border: 2px solid #2d5016;
        }

        .btn-secondary:hover {
            background: #2d5016;
            color: white;
        }

        /* Quick Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 4px solid #2d5016;
        }

        .stat-card.gold-border {
            border-left-color: #d4af37;
        }

        .stat-card.blue-border {
            border-left-color: #2196F3;
        }

        .stat-card.orange-border {
            border-left-color: #FF9800;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c2c2c;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Dashboard Sections */
        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .section-header {
            background: linear-gradient(135deg, #2d5016 0%, #3d6b1e 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header.gold {
            background: linear-gradient(135deg, #b8973a 0%, #d4af37 100%);
        }

        .section-header.blue {
            background: linear-gradient(135deg, #1565C0 0%, #2196F3 100%);
        }

        .section-header.orange {
            background: linear-gradient(135deg, #E65100 0%, #FF9800 100%);
        }

        .section-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .section-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .section-body {
            padding: 25px;
        }

        .section-body p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .section-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #2d5016;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }

        .section-link:hover {
            color: #d4af37;
        }

        /* Data Lists */
        .data-list {
            list-style: none;
            margin: 0 0 20px 0;
            padding: 0;
        }

        .data-list li {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            color: #444;
        }

        .data-list li:last-child {
            border-bottom: none;
        }

        .data-list .label {
            color: #666;
        }

        .data-list .value {
            font-weight: 600;
            color: #2c2c2c;
        }

        .data-list .value.positive {
            color: #2d5016;
        }

        .data-list .value.negative {
            color: #d32f2f;
        }

        /* Crop Rotation Table */
        .rotation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-bottom: 20px;
        }

        .rotation-table th,
        .rotation-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid #eee;
        }

        .rotation-table th {
            background: #f5f5f5;
            color: #2c2c2c;
            font-weight: 600;
        }

        .rotation-table td {
            color: #444;
        }

        .crop-wheat {
            background: #fff3e0;
            color: #e65100;
        }

        .crop-corn {
            background: #fff9c4;
            color: #f57f17;
        }

        .crop-milo {
            background: #ffebee;
            color: #c62828;
        }

        .crop-fallow {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .crop-soybeans {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* Sliding Scale Slider */
        .slider-container {
            margin: 20px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }

        .slider-track {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            position: relative;
            margin-bottom: 5px;
        }

        .slider-fill {
            height: 100%;
            background: linear-gradient(90deg, #d32f2f 0%, #ffa000 50%, #2d5016 100%);
            border-radius: 4px;
            position: absolute;
            left: 0;
            top: 0;
        }

        .slider-markers {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #999;
        }

        /* Insurance Summary */
        .insurance-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .insurance-item {
            text-align: center;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .insurance-item .crop {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .insurance-item .acres {
            font-size: 20px;
            font-weight: bold;
            color: #2c2c2c;
        }

        .insurance-item .acres small {
            font-size: 12px;
            font-weight: normal;
            color: #666;
        }

        /* Progress Bars */
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d5016, #4caf50);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        /* Alert Boxes */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .alert-warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }

        .alert-success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .alert-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .alert-icon {
            font-size: 20px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 5px;
        }

        .alert-text {
            font-size: 14px;
            color: #666;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            color: #444;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .quick-action-btn:hover {
            background: #2d5016;
            color: white;
            border-color: #2d5016;
        }

        /* Year Selector */
        .year-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .year-selector select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        /* Full Width Card */
        .full-width-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .full-width-header {
            background: linear-gradient(135deg, #2d5016 0%, #3d6b1e 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .full-width-body {
            padding: 25px;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f9f9f9;
            font-weight: 600;
            color: #2c2c2c;
            font-size: 13px;
            text-transform: uppercase;
        }

        .data-table td {
            color: #444;
        }

        .data-table tr:hover {
            background: #fafafa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-pending {
            background: #fff3e0;
            color: #e65100;
        }

        .status-complete {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e0e0e0;
            border-top-color: #2d5016;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                height: auto;
                padding: 15px 0;
                gap: 15px;
            }

            .page-header {
                flex-direction: column;
                text-align: center;
            }

            .section-grid {
                grid-template-columns: 1fr;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .insurance-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Landlord Access Indicator */
        .landlord-access {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #e8f5e9;
            border-radius: 8px;
            font-size: 14px;
            color: #2d5016;
            margin-bottom: 20px;
        }

        .access-icon {
            width: 20px;
            height: 20px;
            background: #2d5016;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">M77 AG</div>
                <div class="breadcrumb">
                    <a href="/admin">Admin</a> / Farming Dashboard
                </div>
            </div>
            <div class="user-info">
                <span class="user-name" id="userName">Loading...</span>
                <span class="role-badge" id="userRole">Admin</span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <main class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1>Farming Operations Dashboard</h1>
                <p>Comprehensive overview of all farming operations, crops, insurance, and inventory</p>
            </div>
            <div class="header-actions">
                <div class="year-selector">
                    <label for="yearSelect">Crop Year:</label>
                    <select id="yearSelect" onchange="changeYear()">
                        <option value="2025" selected>2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <a href="#" class="btn btn-secondary" onclick="exportReport()">Export Report</a>
                <a href="#" class="btn btn-primary" onclick="openSettings()">Settings</a>
            </div>
        </div>

        <!-- Landlord Access Notice -->
        <div class="landlord-access">
            <span class="access-icon">L</span>
            <span>Landlords have read-only access to view their properties, crop plans, and financial projections.</span>
        </div>

        <!-- Quick Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="totalAcres">11,929</div>
                <div class="stat-label">Total Acres</div>
            </div>
            <div class="stat-card gold-border">
                <div class="stat-value" id="totalFields">154</div>
                <div class="stat-label">Active Fields</div>
            </div>
            <div class="stat-card blue-border">
                <div class="stat-value" id="landlordsCount">7</div>
                <div class="stat-label">Farm Operations</div>
            </div>
            <div class="stat-card orange-border">
                <div class="stat-value" id="countyCount">3</div>
                <div class="stat-label">Counties</div>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="section-grid">
            <!-- Crop Inventory -->
            <div class="section-card">
                <div class="section-header">
                    <h3>Crop Inventory</h3>
                    <span class="section-badge">Current Year</span>
                </div>
                <div class="section-body">
                    <p>Track grain in storage, contracted bushels, and available inventory across all locations.</p>

                    <ul class="data-list" id="inventoryList">
                        <li>
                            <span class="label">Corn (On-Farm)</span>
                            <span class="value">Loading...</span>
                        </li>
                    </ul>

                    <div class="quick-actions">
                        <a href="farming/inventory.html" class="quick-action-btn">View All</a>
                        <a href="farming/inventory.html?action=add" class="quick-action-btn">Add Inventory</a>
                        <a href="farming/inventory.html?action=sell" class="quick-action-btn">Record Sale</a>
                    </div>
                </div>
            </div>

            <!-- Growing Crops / Current Season -->
            <div class="section-card">
                <div class="section-header gold">
                    <h3>Growing Crops</h3>
                    <span class="section-badge" id="growingCropsBadge">2025 Season</span>
                </div>
                <div class="section-body">
                    <p>Current crops in the ground and their growth stages.</p>

                    <ul class="data-list" id="growingCropsList">
                        <li>
                            <span class="label">Loading...</span>
                            <span class="value">--</span>
                        </li>
                    </ul>

                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 65%;"></div>
                    </div>
                    <div style="font-size: 12px; color: #666; text-align: center;">
                        65% of planned acres planted
                    </div>

                    <div class="quick-actions">
                        <a href="farming/growing.html" class="quick-action-btn">View Map</a>
                        <a href="farming/planting-plan.html" class="quick-action-btn">Planting Plan</a>
                    </div>
                </div>
            </div>

            <!-- Crop Rotations -->
            <div class="section-card">
                <div class="section-header blue">
                    <h3>Crop Rotations</h3>
                    <span class="section-badge">10-Year Plan</span>
                </div>
                <div class="section-body">
                    <p>Multi-year rotation schedule by field and farm operation.</p>

                    <table class="rotation-table" id="rotationTable">
                        <thead>
                            <tr id="rotationTableHeader">
                                <th>Field</th>
                                <th>2024</th>
                                <th>2025</th>
                                <th>2026</th>
                            </tr>
                        </thead>
                        <tbody id="rotationTableBody">
                            <tr>
                                <td colspan="4">Loading rotation data...</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="quick-actions">
                        <a href="farming/rotations.html" class="quick-action-btn">Full Rotation View</a>
                        <a href="farming/rotations.html?action=edit" class="quick-action-btn">Edit Plans</a>
                    </div>
                </div>
            </div>

            <!-- Crop Insurance -->
            <div class="section-card">
                <div class="section-header orange">
                    <h3>Crop Insurance</h3>
                    <span class="section-badge">2025 Policies</span>
                </div>
                <div class="section-body">
                    <p>Revenue Protection coverage by crop type. Premium split: 65% M77AG / 35% Landlord.</p>

                    <div class="insurance-grid" id="insuranceGrid">
                        <div class="insurance-item">
                            <div class="crop">Loading...</div>
                            <div class="acres">-- <small>acres</small></div>
                        </div>
                    </div>

                    <ul class="data-list" id="insuranceList">
                        <li>
                            <span class="label">Total Premium</span>
                            <span class="value">Loading...</span>
                        </li>
                    </ul>

                    <div class="quick-actions">
                        <a href="farming/insurance.html" class="quick-action-btn">View Policies</a>
                        <a href="farming/insurance.html?view=claims" class="quick-action-btn">Claims</a>
                        <a href="farming/insurance.html?view=aph" class="quick-action-btn">APH History</a>
                    </div>
                </div>
            </div>

            <!-- Projected Costs & Revenue -->
            <div class="section-card">
                <div class="section-header">
                    <h3>Projected Costs & Revenue</h3>
                    <span class="section-badge">2025 Forecast</span>
                </div>
                <div class="section-body">
                    <p>Estimated financial projections based on current prices and yields.</p>

                    <ul class="data-list" id="projectionsList">
                        <li>
                            <span class="label">Projected Revenue</span>
                            <span class="value">Loading...</span>
                        </li>
                    </ul>

                    <div class="quick-actions">
                        <a href="farming/projections.html" class="quick-action-btn">Detailed Analysis</a>
                        <a href="farming/projections.html?view=scenarios" class="quick-action-btn">Price Scenarios</a>
                    </div>
                </div>
            </div>

            <!-- Planting Plans -->
            <div class="section-card">
                <div class="section-header gold">
                    <h3>Planting Plans</h3>
                    <span class="section-badge" id="plantingPlanBadge">2025 Schedule</span>
                </div>
                <div class="section-body">
                    <p>Seed varieties, planting rates, and scheduling for current season.</p>

                    <div class="alert alert-info" id="plantingAlert">
                        <div class="alert-icon">i</div>
                        <div class="alert-content">
                            <div class="alert-title" id="plantingAlertTitle">Loading...</div>
                            <div class="alert-text" id="plantingAlertText">Loading planting data...</div>
                        </div>
                    </div>

                    <ul class="data-list" id="plantingPlanList">
                        <li>
                            <span class="label">Loading...</span>
                            <span class="value">--</span>
                        </li>
                    </ul>

                    <div class="quick-actions">
                        <a href="farming/planting-plan.html" class="quick-action-btn">View Full Plan</a>
                        <a href="farming/seed-orders.html" class="quick-action-btn">Seed Orders</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sliding Scale Inventory Management -->
        <div class="full-width-section">
            <div class="full-width-header">
                <h3>Sliding Scale Inventory Management</h3>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="configureSlidingScale()">Configure Scales</button>
                    <button class="btn btn-primary" onclick="checkTriggers()">Check Triggers</button>
                </div>
            </div>
            <div class="full-width-body">
                <p style="color: #666; margin-bottom: 25px;">
                    Set price targets to automatically trigger sales when market conditions are met.
                    Configure tiered selling to spread risk and capture price opportunities.
                </p>

                <div class="section-grid" style="margin-bottom: 0;" id="slidingScaleContainer">
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; text-align: center;">
                        <p style="color: #666;">No sliding scales configured. Click "Configure Scales" to set up price targets.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Farm Operations Overview -->
        <div class="full-width-section">
            <div class="full-width-header">
                <h3>Farm Operations Summary</h3>
                <a href="farming/farms.html" class="btn btn-secondary">View All Farms</a>
            </div>
            <div class="full-width-body">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Farm</th>
                            <th>Total Acres</th>
                            <th>Fields</th>
                            <th>County</th>
                            <th>Primary Crops</th>
                            <th>Lease Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="farmOperationsBody">
                        <tr>
                            <td colspan="7" style="text-align: center;">Loading farm data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alerts & Notifications -->
        <div class="full-width-section">
            <div class="full-width-header">
                <h3>Alerts & Notifications</h3>
                <button class="btn btn-secondary" onclick="clearAlerts()">Clear All</button>
            </div>
            <div class="full-width-body" id="alertsContainer">
                <div class="alert alert-info">
                    <div class="alert-icon">i</div>
                    <div class="alert-content">
                        <div class="alert-title">Loading Alerts</div>
                        <div class="alert-text">Fetching notifications and alerts...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Check authentication
        const token = localStorage.getItem('landManagementToken') || localStorage.getItem('token');

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadAllDashboardData();
        });

        async function loadAllDashboardData() {
            const year = document.getElementById('yearSelect').value;

            // Load all data in parallel
            await Promise.all([
                loadDashboardSummary(year),
                loadInventoryData(year),
                loadInsuranceData(year),
                loadProjections(year),
                loadPlantingPlan(year),
                loadRotations(year),
                loadSlidingScaleStatus(year),
                loadAlerts()
            ]);
        }

        function loadUserInfo() {
            if (token) {
                fetch('/api/land-management/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.user) {
                        document.getElementById('userName').textContent = data.user.name || data.user.email;
                        document.getElementById('userRole').textContent = data.user.role || 'User';
                    }
                })
                .catch(() => {
                    document.getElementById('userName').textContent = 'Admin User';
                    document.getElementById('userRole').textContent = 'Farm Owner';
                });
            } else {
                document.getElementById('userName').textContent = 'Admin User';
                document.getElementById('userRole').textContent = 'Farm Owner';
            }
        }

        async function loadDashboardSummary(year) {
            try {
                const response = await fetch(`/api/farming-dashboard/summary?year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalAcres').textContent = data.stats.totalAcres.toLocaleString();
                    document.getElementById('totalFields').textContent = data.stats.totalFields.toLocaleString();
                    document.getElementById('landlordsCount').textContent = data.stats.farmCount;
                    document.getElementById('countyCount').textContent = data.stats.countyCount;

                    // Update growing crops section
                    updateGrowingCrops(data.growingCrops);

                    // Update farm operations table
                    updateFarmOperationsTable(data.farmSummary);

                    // Update rotation preview
                    updateRotationPreview(data.rotationPreview, data.rotationYears);
                }
            } catch (error) {
                console.error('Error loading dashboard summary:', error);
            }
        }

        function updateGrowingCrops(growingCrops) {
            const container = document.getElementById('growingCropsList');
            if (!container) return;

            let html = '';
            let totalPlanted = 0;

            for (const [crop, acres] of Object.entries(growingCrops)) {
                totalPlanted += acres;
                html += `<li>
                    <span class="label">${formatCropName(crop)}</span>
                    <span class="value">${acres.toLocaleString()} acres</span>
                </li>`;
            }

            container.innerHTML = html;
        }

        function formatCropName(crop) {
            const names = {
                'corn': 'Corn',
                'wheat': 'Winter Wheat',
                'milo': 'Milo (Sorghum)',
                'soybeans': 'Soybeans',
                'fallow': 'Fallow',
                'sunflower': 'Sunflower'
            };
            return names[crop] || crop.charAt(0).toUpperCase() + crop.slice(1);
        }

        function updateFarmOperationsTable(farmSummary) {
            const tbody = document.getElementById('farmOperationsBody');
            if (!tbody) return;

            let html = '';
            farmSummary.forEach(farm => {
                const crops = Object.keys(farm.crops).map(c => formatCropName(c)).join(', ') || 'N/A';
                const leaseTypes = Object.keys(farm.leaseTypes)
                    .map(t => t.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()))
                    .join(' / ') || 'N/A';

                html += `<tr>
                    <td><strong>${farm.farmCode}</strong></td>
                    <td>${Math.round(farm.totalAcres).toLocaleString()}</td>
                    <td>${farm.fieldCount}</td>
                    <td>${farm.counties.join(' / ') || 'N/A'}</td>
                    <td>${crops}</td>
                    <td>${leaseTypes}</td>
                    <td><span class="status-badge status-active">Active</span></td>
                </tr>`;
            });

            tbody.innerHTML = html;
        }

        function updateRotationPreview(rotations, years) {
            const container = document.getElementById('rotationTableBody');
            if (!container) return;

            let html = '';
            rotations.slice(0, 5).forEach(field => {
                html += `<tr><td>${field.fieldName}</td>`;
                years.forEach(year => {
                    const crop = field.years[year];
                    const cropClass = crop ? `crop-${crop.toLowerCase()}` : '';
                    const cropCode = getCropCode(crop);
                    html += `<td class="${cropClass}">${cropCode}</td>`;
                });
                html += '</tr>';
            });

            container.innerHTML = html;
        }

        function getCropCode(crop) {
            const codes = {
                'wheat': 'WHT',
                'corn': 'CRN',
                'milo': 'MLO',
                'fallow': 'FAL',
                'soybeans': 'SOY',
                'sunflower': 'SUN'
            };
            return crop ? (codes[crop.toLowerCase()] || crop.substring(0, 3).toUpperCase()) : '-';
        }

        async function loadInventoryData(year) {
            try {
                const response = await fetch(`/api/farming-dashboard/inventory?year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    updateInventorySection(data.summary);
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        function updateInventorySection(summary) {
            const container = document.getElementById('inventoryList');
            if (!container) return;

            let html = '';
            for (const [crop, data] of Object.entries(summary.byCrop)) {
                html += `<li>
                    <span class="label">${formatCropName(crop)} (On-Farm)</span>
                    <span class="value">${data.onFarm.toLocaleString()} bu</span>
                </li>`;
                if (data.elevator > 0) {
                    html += `<li>
                        <span class="label">${formatCropName(crop)} (Elevator)</span>
                        <span class="value">${data.elevator.toLocaleString()} bu</span>
                    </li>`;
                }
            }
            html += `<li>
                <span class="label">Contracted</span>
                <span class="value negative">-${summary.contracted.toLocaleString()} bu</span>
            </li>`;
            html += `<li>
                <span class="label">Available</span>
                <span class="value positive">${summary.available.toLocaleString()} bu</span>
            </li>`;

            container.innerHTML = html;
        }

        async function loadInsuranceData(year) {
            try {
                const response = await fetch(`/api/farming-dashboard/insurance?year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    updateInsuranceSection(data.summary);
                }
            } catch (error) {
                console.error('Error loading insurance:', error);
            }
        }

        function updateInsuranceSection(summary) {
            const grid = document.getElementById('insuranceGrid');
            const list = document.getElementById('insuranceList');

            if (grid) {
                let html = '';
                for (const [crop, data] of Object.entries(summary.byCrop)) {
                    html += `<div class="insurance-item">
                        <div class="crop">${formatCropName(crop)}</div>
                        <div class="acres">${data.acres.toLocaleString()} <small>acres</small></div>
                    </div>`;
                }
                grid.innerHTML = html;
            }

            if (list) {
                list.innerHTML = `
                    <li>
                        <span class="label">Total Premium</span>
                        <span class="value">$${summary.totalPremium.toLocaleString()}</span>
                    </li>
                    <li>
                        <span class="label">M77 Share (65%)</span>
                        <span class="value">$${summary.m77Share.toLocaleString()}</span>
                    </li>
                    <li>
                        <span class="label">LL Share (35%)</span>
                        <span class="value">$${summary.landlordShare.toLocaleString()}</span>
                    </li>
                `;
            }
        }

        async function loadProjections(year) {
            try {
                const response = await fetch(`/api/farming-dashboard/projections?year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    updateProjectionsSection(data.projections);
                }
            } catch (error) {
                console.error('Error loading projections:', error);
            }
        }

        function updateProjectionsSection(projections) {
            const container = document.getElementById('projectionsList');
            if (!container) return;

            container.innerHTML = `
                <li>
                    <span class="label">Projected Revenue</span>
                    <span class="value positive">$${projections.projectedRevenue.toLocaleString()}</span>
                </li>
                <li>
                    <span class="label">Operating Costs</span>
                    <span class="value negative">-$${projections.operatingCosts.toLocaleString()}</span>
                </li>
                <li>
                    <span class="label">Land Rent</span>
                    <span class="value negative">-$${projections.landRent.toLocaleString()}</span>
                </li>
                <li>
                    <span class="label">Insurance</span>
                    <span class="value negative">-$${projections.insuranceCosts.toLocaleString()}</span>
                </li>
                <li>
                    <span class="label">Projected Net</span>
                    <span class="value ${projections.projectedNet >= 0 ? 'positive' : 'negative'}">
                        ${projections.projectedNet >= 0 ? '$' : '-$'}${Math.abs(projections.projectedNet).toLocaleString()}
                    </span>
                </li>
            `;
        }

        async function loadPlantingPlan(year) {
            try {
                const response = await fetch(`/api/farming-dashboard/planting-plan?year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    updatePlantingPlanSection(data.plantingPlan, data.cropSummary);
                }
            } catch (error) {
                console.error('Error loading planting plan:', error);
            }
        }

        function updatePlantingPlanSection(plantingPlan, cropSummary) {
            const container = document.getElementById('plantingPlanList');
            if (!container) return;

            let html = '';
            plantingPlan.slice(0, 5).forEach(plan => {
                html += `<li>
                    <span class="label">${plan.fieldNumber || ''} ${plan.fieldName}</span>
                    <span class="value">${plan.acres.toFixed(2)} ac</span>
                </li>`;
            });

            container.innerHTML = html;
        }

        async function loadRotations(year) {
            try {
                const response = await fetch(`/api/farming-dashboard/rotations?startYear=${year - 1}&endYear=${year + 2}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    // Data handled in summary endpoint
                }
            } catch (error) {
                console.error('Error loading rotations:', error);
            }
        }

        async function loadSlidingScaleStatus(year) {
            try {
                const response = await fetch(`/api/farming-dashboard/sliding-scale?year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    updateSlidingScaleSection(data.byCrop);
                }
            } catch (error) {
                console.error('Error loading sliding scale:', error);
            }
        }

        function updateSlidingScaleSection(byCrop) {
            const container = document.getElementById('slidingScaleContainer');
            if (!container || Object.keys(byCrop).length === 0) return;

            let html = '';
            for (const [crop, scales] of Object.entries(byCrop)) {
                scales.forEach(scale => {
                    html += `<div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                        <h4 style="color: #2c2c2c; margin-bottom: 15px;">${formatCropName(crop)} Inventory - ${scale.currentQuantity.toLocaleString()} bu</h4>
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Floor: $${scale.minimumPrice?.toFixed(2) || '0.00'}</span>
                                <span>Target: $${scale.targetPrice?.toFixed(2) || '0.00'}</span>
                            </div>
                            <div class="slider-track">
                                <div class="slider-fill" style="width: 50%;"></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">`;

                    scale.tiers.forEach((tier, i) => {
                        const status = tier.executed ? 'status-complete' : 'status-pending';
                        const statusText = tier.executed ? 'Executed' : 'Pending';
                        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666; font-size: 13px;">Tier ${i + 1}: Sell ${tier.percentToSell}% at $${tier.pricePerBushel?.toFixed(2)}</span>
                            <span class="status-badge ${status}">${statusText}</span>
                        </div>`;
                    });

                    html += `</div></div>`;
                });
            }

            container.innerHTML = html;
        }

        async function loadAlerts() {
            try {
                const response = await fetch('/api/farming-dashboard/alerts', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    updateAlertsSection(data.alerts);
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        function updateAlertsSection(alerts) {
            const container = document.getElementById('alertsContainer');
            if (!container || alerts.length === 0) return;

            let html = '';
            alerts.forEach(alert => {
                const alertClass = `alert-${alert.type}`;
                const icon = alert.type === 'warning' ? '!' : alert.type === 'success' ? '+' : 'i';

                html += `<div class="alert ${alertClass}">
                    <div class="alert-icon">${icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-text">${alert.message}</div>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        function changeYear() {
            loadAllDashboardData();
        }

        function exportReport() {
            const year = document.getElementById('yearSelect').value;
            window.open(`/api/farming-dashboard/export?year=${year}&token=${token}`, '_blank');
        }

        function openSettings() {
            window.location.href = 'farming/settings.html';
        }

        function configureSlidingScale() {
            window.location.href = 'farming/sliding-scale.html';
        }

        async function checkTriggers() {
            try {
                const year = document.getElementById('yearSelect').value;
                const response = await fetch(`/api/farming-dashboard/sliding-scale?year=${year}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success && data.totalActiveScales > 0) {
                    alert(`Found ${data.totalActiveScales} active sliding scales. Check the sliding scale section for trigger status.`);
                } else {
                    alert('No active sliding scales configured.');
                }
            } catch (error) {
                alert('Error checking triggers: ' + error.message);
            }
        }

        function clearAlerts() {
            const container = document.getElementById('alertsContainer');
            if (container) {
                container.innerHTML = '<p style="color: #666; text-align: center;">All alerts cleared.</p>';
            }
        }

        function logout() {
            localStorage.removeItem('landManagementToken');
            localStorage.removeItem('token');
            window.location.href = '/land-management/login.html';
        }
    </script>
</body>
</html>
