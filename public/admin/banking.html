<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking Dashboard - M77 AG Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f3f0;
            color: #2c2c2c;
        }

        .header {
            background: #1a1a1a;
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-left { display: flex; align-items: center; gap: 30px; }

        .logo {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 2px;
            color: #d4af37;
        }

        .nav-links { display: flex; gap: 20px; }

        .nav-links a {
            color: #ccc;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active { color: #d4af37; }

        .header-right { display: flex; gap: 20px; align-items: center; }

        .user-info { display: flex; align-items: center; gap: 10px; }

        .user-role {
            font-size: 11px;
            color: #1a5f2a;
            background: rgba(45,143,74,0.2);
            padding: 3px 8px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-name { font-size: 14px; color: #d4af37; }

        .logout-btn {
            padding: 10px 20px;
            background: #d4af37;
            color: #1a1a1a;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .logout-btn:hover { background: #c49d2e; }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        .breadcrumb {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .breadcrumb a { color: #2d5016; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }

        .page-title {
            font-size: 36px;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .page-subtitle { font-size: 16px; color: #666; }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .kpi-card.cash::before { background: #2d8f4a; }
        .kpi-card.receivable::before { background: #d4af37; }
        .kpi-card.debt::before { background: #dc3545; }
        .kpi-card.payments::before { background: #0070ba; }
        .kpi-card.networth::before { background: #1a5f2a; }

        .kpi-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .kpi-value.positive { color: #2d8f4a; }
        .kpi-value.negative { color: #dc3545; }

        .kpi-sub { font-size: 12px; color: #999; margin-top: 5px; }

        /* Section Panels */
        .panel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .panel-full {
            grid-column: 1 / -1;
        }

        .panel-header {
            padding: 20px 25px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title { font-size: 18px; font-weight: 700; color: #1a1a1a; }

        .panel-action {
            padding: 6px 16px;
            background: #f8f7f5;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }

        .panel-action:hover { border-color: #d4af37; color: #1a1a1a; }

        .panel-body { padding: 25px; }

        /* Account Cards */
        .account-list { display: flex; flex-direction: column; gap: 12px; }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f7f5;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .account-item:hover { background: #f0ede8; }

        .account-info { display: flex; align-items: center; gap: 15px; }

        .account-icon {
            width: 42px;
            height: 42px;
            background: #1a1a1a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d4af37;
            font-weight: 700;
            font-size: 14px;
        }

        .account-name { font-weight: 600; font-size: 14px; }
        .account-bank { font-size: 12px; color: #999; }

        .account-balance { text-align: right; }
        .account-amount { font-weight: 700; font-size: 16px; }
        .account-available { font-size: 12px; color: #999; }

        .account-primary {
            font-size: 10px;
            background: #d4af37;
            color: #1a1a1a;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 8px;
        }

        /* Loan Items */
        .loan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f7f5;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .loan-info { flex: 1; }
        .loan-name { font-weight: 600; font-size: 14px; }
        .loan-lender { font-size: 12px; color: #999; }

        .loan-details { display: flex; gap: 25px; align-items: center; }

        .loan-detail { text-align: center; }
        .loan-detail-value { font-weight: 700; font-size: 14px; }
        .loan-detail-label { font-size: 11px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }

        .loan-type-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-equipment { background: #e8e8e8; color: #444; }
        .badge-land { background: #e8f5e9; color: #2d5016; }
        .badge-operating { background: #fff3cd; color: #856404; }
        .badge-vehicle { background: #e3f2fd; color: #1565c0; }

        /* Invoice Table */
        .invoice-table { width: 100%; border-collapse: collapse; }

        .invoice-table th {
            text-align: left;
            padding: 12px 15px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
            border-bottom: 2px solid #f0f0f0;
        }

        .invoice-table td {
            padding: 12px 15px;
            font-size: 14px;
            border-bottom: 1px solid #f5f5f5;
        }

        .invoice-table tr:hover td { background: #fafaf8; }

        .status-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .status-paid { background: #e8f5e9; color: #2d8f4a; }
        .status-sent { background: #e3f2fd; color: #1565c0; }
        .status-partial { background: #fff3cd; color: #856404; }
        .status-overdue { background: #fce4ec; color: #c62828; }
        .status-draft { background: #f5f5f5; color: #666; }

        /* Aging Chart */
        .aging-bar {
            display: flex;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }

        .aging-segment { transition: width 0.5s; }
        .aging-current { background: #2d8f4a; }
        .aging-30 { background: #d4af37; }
        .aging-60 { background: #ff9800; }
        .aging-90 { background: #f44336; }
        .aging-over90 { background: #880e4f; }

        .aging-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .aging-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }

        .aging-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Upcoming Payments */
        .payment-timeline { display: flex; flex-direction: column; gap: 12px; }

        .payment-event {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: #f8f7f5;
            border-radius: 8px;
        }

        .payment-date {
            min-width: 50px;
            text-align: center;
        }

        .payment-date-day {
            font-size: 22px;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1;
        }

        .payment-date-month {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
        }

        .payment-desc { flex: 1; }
        .payment-name { font-weight: 600; font-size: 14px; }
        .payment-lender { font-size: 12px; color: #999; }
        .payment-amount { font-weight: 700; font-size: 16px; color: #dc3545; }

        /* Quick Actions */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .quick-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 20px 15px;
            background: #f8f7f5;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s;
        }

        .quick-action:hover { border-color: #d4af37; background: white; }

        .qa-icon {
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            color: #2d5016;
        }

        .qa-label { font-size: 13px; font-weight: 600; text-align: center; }
        .qa-sub { font-size: 11px; color: #666; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-title { font-size: 16px; font-weight: 600; color: #666; margin-bottom: 8px; }
        .empty-state-desc { font-size: 14px; }

        .footer {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .kpi-grid { grid-template-columns: repeat(3, 1fr); }
            .quick-actions-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .panel-grid { grid-template-columns: 1fr; }
            .loan-details { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">M77 AG</div>
            <nav class="nav-links">
                <a href="/admin/dashboard">Dashboard</a>
                <a href="/admin/financials">Financials</a>
                <a href="/admin/banking" class="active">Banking</a>
                <a href="/admin/hunting-bookings">Hunting</a>
                <a href="/admin/equipment">Equipment</a>
                <a href="/admin/rentals">Rentals</a>
            </nav>
        </div>
        <div class="header-right">
            <div class="user-info">
                <span class="user-role" id="userRole">Admin</span>
                <span class="user-name" id="userName">Welcome</span>
            </div>
            <button class="logout-btn" onclick="logout()">LOGOUT</button>
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <div>
                <div class="breadcrumb">
                    <a href="/admin/dashboard">Admin</a> / <a href="/admin/financials">Financials</a> / Banking Dashboard
                </div>
                <h1 class="page-title">Banking Dashboard</h1>
                <p class="page-subtitle">Accounts, loans, invoices, and cash flow management</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="panel-action" onclick="refreshDashboard()">Refresh</button>
                <button class="panel-action" onclick="exportBankingData()">Export</button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card cash">
                <div class="kpi-label">Total Cash</div>
                <div class="kpi-value positive" id="totalCash">$0</div>
                <div class="kpi-sub" id="cashAccounts">0 accounts</div>
            </div>
            <div class="kpi-card receivable">
                <div class="kpi-label">Accounts Receivable</div>
                <div class="kpi-value" id="totalReceivable">$0</div>
                <div class="kpi-sub" id="receivableCount">0 invoices outstanding</div>
            </div>
            <div class="kpi-card debt">
                <div class="kpi-label">Total Debt</div>
                <div class="kpi-value negative" id="totalDebt">$0</div>
                <div class="kpi-sub" id="debtCount">0 active loans</div>
            </div>
            <div class="kpi-card payments">
                <div class="kpi-label">Monthly Payments</div>
                <div class="kpi-value" id="monthlyPayments">$0</div>
                <div class="kpi-sub">loan payments due</div>
            </div>
            <div class="kpi-card networth">
                <div class="kpi-label">Net Position</div>
                <div class="kpi-value positive" id="netPosition">$0</div>
                <div class="kpi-sub" id="debtRatio">-- debt-to-asset ratio</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="panel panel-full" style="margin-bottom: 25px;">
            <div class="panel-header">
                <div class="panel-title">Quick Actions</div>
            </div>
            <div class="panel-body">
                <div class="quick-actions-grid">
                    <a href="#" class="quick-action" onclick="showCreateInvoice()">
                        <div class="qa-icon">+</div>
                        <span class="qa-label">New Invoice</span>
                        <span class="qa-sub">Create & send</span>
                    </a>
                    <a href="#" class="quick-action" onclick="showRecordPayment()">
                        <div class="qa-icon">$</div>
                        <span class="qa-label">Record Payment</span>
                        <span class="qa-sub">Invoice or loan</span>
                    </a>
                    <a href="#" class="quick-action" onclick="showAddAccount()">
                        <div class="qa-icon">BK</div>
                        <span class="qa-label">Add Account</span>
                        <span class="qa-sub">Bank account</span>
                    </a>
                    <a href="#" class="quick-action" onclick="showAddLoan()">
                        <div class="qa-icon">LN</div>
                        <span class="qa-label">Add Loan</span>
                        <span class="qa-sub">New financing</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Accounts & Loans -->
        <div class="panel-grid">
            <!-- Bank Accounts -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Bank Accounts</div>
                    <button class="panel-action" onclick="showAddAccount()">+ Add Account</button>
                </div>
                <div class="panel-body">
                    <div class="account-list" id="accountsList">
                        <div class="empty-state">
                            <div class="empty-state-title">No accounts added yet</div>
                            <div class="empty-state-desc">Add your bank accounts to track balances and cash flow</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Payments -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Upcoming Payments</div>
                    <span class="panel-action">Next 30 Days</span>
                </div>
                <div class="panel-body">
                    <div class="payment-timeline" id="upcomingPayments">
                        <div class="empty-state">
                            <div class="empty-state-title">No upcoming payments</div>
                            <div class="empty-state-desc">Loan payments will appear here when loans are added</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loans & AR Aging -->
        <div class="panel-grid">
            <!-- Active Loans -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Active Loans</div>
                    <button class="panel-action" onclick="showAddLoan()">+ Add Loan</button>
                </div>
                <div class="panel-body" id="loansList">
                    <div class="empty-state">
                        <div class="empty-state-title">No loans tracked yet</div>
                        <div class="empty-state-desc">Add equipment, land, and operating loans to track your debt portfolio</div>
                    </div>
                </div>
            </div>

            <!-- AR Aging -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Accounts Receivable Aging</div>
                </div>
                <div class="panel-body">
                    <div id="agingChart">
                        <div class="aging-bar">
                            <div class="aging-segment aging-current" id="agingCurrent" style="width: 0%"></div>
                            <div class="aging-segment aging-30" id="aging30" style="width: 0%"></div>
                            <div class="aging-segment aging-60" id="aging60" style="width: 0%"></div>
                            <div class="aging-segment aging-90" id="aging90" style="width: 0%"></div>
                            <div class="aging-segment aging-over90" id="agingOver90" style="width: 0%"></div>
                        </div>
                        <div class="aging-legend">
                            <div class="aging-legend-item">
                                <div class="aging-dot" style="background:#2d8f4a"></div>
                                <span>Current: <strong id="agingCurrentAmt">$0</strong></span>
                            </div>
                            <div class="aging-legend-item">
                                <div class="aging-dot" style="background:#d4af37"></div>
                                <span>1-30 Days: <strong id="aging30Amt">$0</strong></span>
                            </div>
                            <div class="aging-legend-item">
                                <div class="aging-dot" style="background:#ff9800"></div>
                                <span>31-60 Days: <strong id="aging60Amt">$0</strong></span>
                            </div>
                            <div class="aging-legend-item">
                                <div class="aging-dot" style="background:#f44336"></div>
                                <span>61-90 Days: <strong id="aging90Amt">$0</strong></span>
                            </div>
                            <div class="aging-legend-item">
                                <div class="aging-dot" style="background:#880e4f"></div>
                                <span>90+ Days: <strong id="agingOver90Amt">$0</strong></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Invoices -->
        <div class="panel panel-full" style="margin-bottom: 25px;">
            <div class="panel-header">
                <div class="panel-title">Recent Invoices</div>
                <button class="panel-action" onclick="showCreateInvoice()">+ New Invoice</button>
            </div>
            <div class="panel-body">
                <table class="invoice-table" id="invoiceTable">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Balance</th>
                            <th>Status</th>
                            <th>Due Date</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                No invoices yet. Create your first invoice to get started.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer">
        2025 M77 AG Banking Dashboard. All rights reserved. McConnell Enterprises LLC.
    </div>

    <!-- Create Invoice Modal -->
    <div id="invoiceModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; display:none; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:12px; max-width:700px; width:90%; max-height:85vh; overflow-y:auto; padding:40px;">
            <h2 style="margin-bottom:25px; font-size:24px;">Create New Invoice</h2>
            <form id="invoiceForm">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:5px;">Invoice Type</label>
                        <select name="type" required style="width:100%; padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;">
                            <option value="customer_invoice">Customer Invoice</option>
                            <option value="custom_work">Custom Work</option>
                            <option value="hunting_lease">Hunting Lease</option>
                            <option value="equipment_sale">Equipment Sale</option>
                            <option value="rental">Rental</option>
                            <option value="landlord_statement">Landlord Statement</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:5px;">Terms</label>
                        <select name="terms" style="width:100%; padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;">
                            <option value="due_on_receipt">Due on Receipt</option>
                            <option value="net_10">Net 10</option>
                            <option value="net_15">Net 15</option>
                            <option value="net_30" selected>Net 30</option>
                            <option value="net_60">Net 60</option>
                            <option value="net_90">Net 90</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:block; font-size:13px; font-weight:600; margin-bottom:5px;">Customer / Company Name</label>
                    <input type="text" name="toName" required style="width:100%; padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;" placeholder="Customer or company name">
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:5px;">Email</label>
                        <input type="email" name="toEmail" style="width:100%; padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;" placeholder="customer@email.com">
                    </div>
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:5px;">Phone</label>
                        <input type="text" name="toPhone" style="width:100%; padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;" placeholder="970-555-0000">
                    </div>
                </div>

                <h3 style="font-size:16px; margin:20px 0 10px; padding-top:15px; border-top:1px solid #f0f0f0;">Line Items</h3>
                <div id="lineItems">
                    <div class="line-item" style="display:grid; grid-template-columns:3fr 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <input type="text" placeholder="Description" name="itemDesc[]" required style="padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;">
                        <input type="number" placeholder="Qty" name="itemQty[]" value="1" min="1" style="padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;">
                        <input type="number" placeholder="Unit Price" name="itemPrice[]" required step="0.01" style="padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;">
                        <input type="text" placeholder="Amount" name="itemAmount[]" readonly style="padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px; background:#f8f7f5;">
                    </div>
                </div>
                <button type="button" onclick="addLineItem()" style="padding:8px 16px; background:#f8f7f5; border:1px solid #e0e0e0; border-radius:5px; cursor:pointer; font-size:13px; margin-bottom:20px;">+ Add Line Item</button>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div>
                        <label style="display:block; font-size:13px; font-weight:600; margin-bottom:5px;">Notes</label>
                        <textarea name="notes" rows="3" style="width:100%; padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;" placeholder="Additional notes..."></textarea>
                    </div>
                    <div style="text-align:right; padding-top:20px;">
                        <div style="font-size:14px; color:#666; margin-bottom:8px;">Subtotal: <strong id="modalSubtotal">$0.00</strong></div>
                        <div style="font-size:22px; font-weight:700;">Total: <strong id="modalTotal">$0.00</strong></div>
                    </div>
                </div>

                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                    <button type="button" onclick="closeModal()" style="padding:12px 25px; background:#f8f7f5; border:1px solid #e0e0e0; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">Cancel</button>
                    <button type="submit" style="padding:12px 25px; background:#d4af37; color:#1a1a1a; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:700;">Create Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Authentication check
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (!token) { window.location.href = '/admin/login'; return false; }
            return true;
        }

        function getToken() { return localStorage.getItem('adminToken'); }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '$0';
            const num = Math.abs(amount);
            if (num >= 1000000) return (amount < 0 ? '-' : '') + '$' + (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (amount < 0 ? '-' : '') + '$' + (num / 1000).toFixed(1) + 'K';
            return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Load banking dashboard data
        async function loadDashboard() {
            try {
                const token = getToken();
                const headers = { 'Authorization': 'Bearer ' + token };

                const [dashRes, invoiceRes, agingRes] = await Promise.all([
                    fetch('/api/banking/dashboard', { headers }).then(r => r.json()).catch(() => ({ success: false })),
                    fetch('/api/invoices/dashboard', { headers }).then(r => r.json()).catch(() => ({ success: false })),
                    fetch('/api/invoices/aging', { headers }).then(r => r.json()).catch(() => ({ success: false }))
                ]);

                // Update KPIs
                if (dashRes.success) {
                    const d = dashRes.data;
                    document.getElementById('totalCash').textContent = formatCurrency(d.cashPosition?.totalCash || 0);
                    document.getElementById('cashAccounts').textContent = (d.cashPosition?.accounts?.length || 0) + ' accounts';
                    document.getElementById('totalReceivable').textContent = formatCurrency(d.accountsReceivable?.totalReceivable || 0);
                    document.getElementById('receivableCount').textContent = (d.accountsReceivable?.invoiceCount || 0) + ' invoices outstanding';
                    document.getElementById('totalDebt').textContent = formatCurrency(d.debtOverview?.totalDebt || 0);
                    document.getElementById('debtCount').textContent = (d.debtOverview?.loanCount || 0) + ' active loans';
                    document.getElementById('monthlyPayments').textContent = formatCurrency(d.debtOverview?.monthlyPayments || 0);
                    document.getElementById('netPosition').textContent = formatCurrency(d.netPosition?.netWorth || 0);
                    document.getElementById('debtRatio').textContent = (d.netPosition?.debtToAssetRatio || 0) + '% debt-to-asset ratio';

                    // Render accounts
                    renderAccounts(d.cashPosition?.accounts || []);

                    // Render upcoming payments
                    renderUpcomingPayments(d.debtOverview?.upcomingPayments || []);

                    // Render loans
                    renderLoans(d.debtOverview || {});
                }

                // Update invoices
                if (invoiceRes.success) {
                    renderInvoices(invoiceRes.data?.recentInvoices || []);
                }

                // Update aging
                if (agingRes.success) {
                    renderAging(agingRes.data);
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
            }
        }

        function renderAccounts(accounts) {
            const container = document.getElementById('accountsList');
            if (!accounts.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No accounts added yet</div><div class="empty-state-desc">Add your bank accounts to track balances and cash flow</div></div>';
                return;
            }

            container.innerHTML = accounts.map(a => `
                <div class="account-item">
                    <div class="account-info">
                        <div class="account-icon">${a.type === 'checking' ? 'CK' : a.type === 'savings' ? 'SV' : 'BK'}</div>
                        <div>
                            <div class="account-name">${a.name}${a.isPrimary ? '<span class="account-primary">Primary</span>' : ''}</div>
                            <div class="account-bank">${a.bank} ****${a.last4 || '----'}</div>
                        </div>
                    </div>
                    <div class="account-balance">
                        <div class="account-amount">${formatCurrency(a.balance)}</div>
                        <div class="account-available">Available: ${formatCurrency(a.available)}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderUpcomingPayments(payments) {
            const container = document.getElementById('upcomingPayments');
            if (!payments.length) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No upcoming payments</div><div class="empty-state-desc">Loan payments will appear here</div></div>';
                return;
            }

            container.innerHTML = payments.map(p => {
                const d = new Date(p.date);
                return `
                    <div class="payment-event">
                        <div class="payment-date">
                            <div class="payment-date-day">${d.getDate()}</div>
                            <div class="payment-date-month">${d.toLocaleDateString('en-US', { month: 'short' })}</div>
                        </div>
                        <div class="payment-desc">
                            <div class="payment-name">${p.name}</div>
                            <div class="payment-lender">${p.lender}</div>
                        </div>
                        <div class="payment-amount">${formatCurrency(p.amount)}</div>
                    </div>
                `;
            }).join('');
        }

        function renderLoans(debtOverview) {
            const container = document.getElementById('loansList');
            const loans = debtOverview.loans || [];

            if (!loans) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No loans tracked yet</div><div class="empty-state-desc">Add loans to track your debt portfolio</div></div>';
                return;
            }

            // Use byType summary if no individual loans
            const byType = debtOverview.byType || {};
            if (Object.keys(byType).length > 0) {
                container.innerHTML = Object.entries(byType).map(([type, data]) => {
                    const badgeClass = type === 'equipment' ? 'badge-equipment' : type === 'land' ? 'badge-land' : type === 'operating' ? 'badge-operating' : 'badge-vehicle';
                    return `
                        <div class="loan-item">
                            <div class="loan-info">
                                <div class="loan-name">${type.charAt(0).toUpperCase() + type.slice(1)} Loans</div>
                                <div class="loan-lender">${data.count} loan${data.count !== 1 ? 's' : ''}</div>
                            </div>
                            <div class="loan-details">
                                <div class="loan-detail">
                                    <div class="loan-detail-value">${formatCurrency(data.balance)}</div>
                                    <div class="loan-detail-label">Balance</div>
                                </div>
                                <div class="loan-detail">
                                    <div class="loan-detail-value">${formatCurrency(data.monthlyPayment)}</div>
                                    <div class="loan-detail-label">Monthly</div>
                                </div>
                                <span class="loan-type-badge ${badgeClass}">${type}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-title">No loans tracked yet</div><div class="empty-state-desc">Add equipment, land, and operating loans to track your debt portfolio</div></div>';
            }
        }

        function renderInvoices(invoices) {
            const tbody = document.getElementById('invoiceTableBody');
            if (!invoices.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#999;">No invoices yet. Create your first invoice to get started.</td></tr>';
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const statusClass = 'status-' + inv.status;
                return `
                    <tr>
                        <td><strong>${inv.invoiceNumber}</strong></td>
                        <td>${inv.to?.name || '--'}</td>
                        <td>${inv.type.replace(/_/g, ' ')}</td>
                        <td>${formatCurrency(inv.total)}</td>
                        <td>${formatCurrency(inv.balanceDue)}</td>
                        <td><span class="status-badge ${statusClass}">${inv.status}</span></td>
                        <td>${formatDate(inv.dueDate)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderAging(aging) {
            if (!aging) return;

            const total = aging.totalOutstanding || 1;
            const pcts = {
                current: (aging.current?.total || 0) / total * 100,
                d30: (aging.days1to30?.total || 0) / total * 100,
                d60: (aging.days31to60?.total || 0) / total * 100,
                d90: (aging.days61to90?.total || 0) / total * 100,
                over: (aging.over90?.total || 0) / total * 100
            };

            document.getElementById('agingCurrent').style.width = pcts.current + '%';
            document.getElementById('aging30').style.width = pcts.d30 + '%';
            document.getElementById('aging60').style.width = pcts.d60 + '%';
            document.getElementById('aging90').style.width = pcts.d90 + '%';
            document.getElementById('agingOver90').style.width = pcts.over + '%';

            document.getElementById('agingCurrentAmt').textContent = formatCurrency(aging.current?.total || 0);
            document.getElementById('aging30Amt').textContent = formatCurrency(aging.days1to30?.total || 0);
            document.getElementById('aging60Amt').textContent = formatCurrency(aging.days31to60?.total || 0);
            document.getElementById('aging90Amt').textContent = formatCurrency(aging.days61to90?.total || 0);
            document.getElementById('agingOver90Amt').textContent = formatCurrency(aging.over90?.total || 0);
        }

        // Modal functions
        function showCreateInvoice() {
            document.getElementById('invoiceModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('invoiceModal').style.display = 'none';
        }

        function showRecordPayment() {
            alert('Record Payment: Select an invoice from the table to record a payment against it.');
        }

        function showAddAccount() {
            alert('Add Bank Account: Feature available through the Banking API. Use POST /api/banking/accounts to add accounts.');
        }

        function showAddLoan() {
            alert('Add Loan: Feature available through the Banking API. Use POST /api/banking/loans to add loans.');
        }

        function addLineItem() {
            const container = document.getElementById('lineItems');
            const item = document.createElement('div');
            item.className = 'line-item';
            item.style.cssText = 'display:grid; grid-template-columns:3fr 1fr 1fr 1fr; gap:10px; margin-bottom:10px;';
            item.innerHTML = `
                <input type="text" placeholder="Description" name="itemDesc[]" required style="padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;">
                <input type="number" placeholder="Qty" name="itemQty[]" value="1" min="1" style="padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;">
                <input type="number" placeholder="Unit Price" name="itemPrice[]" required step="0.01" style="padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px;">
                <input type="text" placeholder="Amount" name="itemAmount[]" readonly style="padding:10px; border:2px solid #e5e5e5; border-radius:6px; font-size:14px; background:#f8f7f5;">
            `;
            container.appendChild(item);
        }

        // Auto-calculate line item amounts
        document.addEventListener('input', function(e) {
            if (e.target.name === 'itemQty[]' || e.target.name === 'itemPrice[]') {
                const row = e.target.closest('.line-item');
                if (!row) return;
                const qty = parseFloat(row.querySelector('[name="itemQty[]"]').value) || 0;
                const price = parseFloat(row.querySelector('[name="itemPrice[]"]').value) || 0;
                row.querySelector('[name="itemAmount[]"]').value = '$' + (qty * price).toFixed(2);
                updateTotals();
            }
        });

        function updateTotals() {
            let total = 0;
            document.querySelectorAll('.line-item').forEach(row => {
                const qty = parseFloat(row.querySelector('[name="itemQty[]"]').value) || 0;
                const price = parseFloat(row.querySelector('[name="itemPrice[]"]').value) || 0;
                total += qty * price;
            });
            document.getElementById('modalSubtotal').textContent = '$' + total.toFixed(2);
            document.getElementById('modalTotal').textContent = '$' + total.toFixed(2);
        }

        // Submit invoice form
        document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const form = e.target;
            const descs = form.querySelectorAll('[name="itemDesc[]"]');
            const qtys = form.querySelectorAll('[name="itemQty[]"]');
            const prices = form.querySelectorAll('[name="itemPrice[]"]');

            const items = [];
            descs.forEach((desc, i) => {
                if (desc.value) {
                    const qty = parseFloat(qtys[i].value) || 1;
                    const price = parseFloat(prices[i].value) || 0;
                    items.push({
                        description: desc.value,
                        quantity: qty,
                        unitPrice: price,
                        amount: qty * price
                    });
                }
            });

            const termsMap = {
                'due_on_receipt': 0, 'net_10': 10, 'net_15': 15,
                'net_30': 30, 'net_60': 60, 'net_90': 90
            };
            const terms = form.querySelector('[name="terms"]').value;
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + (termsMap[terms] || 30));

            const invoiceData = {
                type: form.querySelector('[name="type"]').value,
                terms: terms,
                to: {
                    name: form.querySelector('[name="toName"]').value,
                    email: form.querySelector('[name="toEmail"]').value,
                    phone: form.querySelector('[name="toPhone"]').value
                },
                items: items,
                dueDate: dueDate.toISOString(),
                notes: form.querySelector('[name="notes"]').value
            };

            try {
                const res = await fetch('/api/invoices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify(invoiceData)
                });

                const data = await res.json();
                if (data.success) {
                    closeModal();
                    form.reset();
                    loadDashboard();
                    alert('Invoice ' + data.data.invoiceNumber + ' created successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (err) {
                console.error('Invoice creation error:', err);
                alert('Failed to create invoice. Check console for details.');
            }
        });

        function refreshDashboard() { loadDashboard(); }

        function exportBankingData() {
            alert('Export functionality: Banking data export will generate a CSV file with all accounts, loans, and invoices.');
        }

        async function loadUserInfo() {
            try {
                const res = await fetch('/api/auth/verify', {
                    headers: { 'Authorization': 'Bearer ' + getToken() }
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.success && data.user) {
                        document.getElementById('userName').textContent = 'Welcome, ' + data.user.name;
                        document.getElementById('userRole').textContent = data.user.role;
                    }
                }
            } catch (err) { console.error('User info error:', err); }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = '/admin/login';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            if (!checkAuth()) return;
            loadUserInfo();
            loadDashboard();
        });
    </script>
</body>
</html>
